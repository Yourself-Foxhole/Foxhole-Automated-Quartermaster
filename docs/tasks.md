# Task Layer Specification

## Rationale
Orders generated by the graph network are often too granular and numerous to present 
directly to users. Displaying raw orders can overwhelm users and reduce engagement. 
A task layer aggregates, prioritizes, and contextualizes these orders, presenting 
actionable units that improve clarity and usability.

## Relationship Between Orders and Tasks
- **Orders**: Represent granular requirements or actions needed by the system
    (e.g., move 10 Bmats from A to B).
- **Tasks**: Aggregate and contextualize orders into actionable suggestions for
  users (e.g., "Deliver all Bmats to Factory").
- **User Interactions**: Users interact with tasks, not raw orders. The bot 
 communicates tasks, and users execute them in-game.

## Task Generation and Management
- **Aggregation**: Orders are merged into tasks based on location, type, and context.
 For example, all production orders at a factory can be combined into a single task.
- **Prioritization**: Tasks are sorted by urgency, impact, and feasibility.
  Criteria may include supply shortages, strategic importance, or available resources.
- **Filtering**: Tasks that are currently impossible (e.g., lack required resources or access) are hidden. Tasks can also be filtered by type (production, delivery, etc.) or location.
- **Opportunistic Tasks**: If extra capacity (e.g., truck space or labor) is available,
  additional tasks may be suggested even if not strictly required.

## Presentation Guidelines
- **Clarity**: Tasks should be described in clear, actionable language.
- **Contextualization**: Only show tasks relevant to the user's current location or role.
- **Manageability**: Limit the number of visible tasks to avoid overwhelming users.
 Use grouping and summarization where possible.
- **Interactivity**: Allow users to sort and filter tasks by priority, type, or location.

## Edge Cases and Extensibility
- **Synchronization**: Ensure tasks stay up-to-date with underlying orders and inventory state.
- **Dynamic Updates**: As game state changes, tasks should be regenerated and reprioritized.
- **Extensibility**: The task system should support new types of tasks and aggregation logic as requirements evolve.

## Example Workflow
1. Graph network generates orders based on supply/demand.
2. Task layer aggregates and prioritizes orders into tasks.
3. Bot presents tasks to users, filtered by context.
4. Users select and execute tasks in-game.
5. Task completion updates inventory and order state, triggering regeneration of tasks.

## Priority Calculation

Task priority is calculated using a weighted combination of multiple algorithms and signals:

### Priority Signals
- **Delta**: Unmet demand or supply shortage (weight: 1.0)
- **Inventory**: Current inventory levels - surplus reduces priority (weight: -0.5)
- **Status**: Node criticality level (critical=2.0, low=1.0, ok=0.0) (weight: 2.0)
- **Distance**: Distance to fulfill (reduces priority) (weight: -0.2)
- **Fluid Dynamics**: Upstream blockage pressure (weight: 1.5)

### Fluid Dynamics-Inspired Priority Algorithm

One key component of the priority system is inspired by fluid dynamics principles, modeling blocked upstream dependencies as water pressure building behind a dam.

**How it works:**
1. Count blocked upstream tasks (water volume behind dam)
2. Sum their relative weights (water density)
3. Apply time-based multipliers (pressure buildup over 5 days)
4. Calculate fluid pressure contribution to final priority

**Key features:**
- Time pressure builds exponentially (1.0x â†’ 5.0x over 5 days)
- Upstream blockages propagate pressure to dependent tasks
- Multiple blockages compound effects like dams in series
- Real-time blocking/unblocking updates priority calculations

**Note:** This is a priority calculation algorithm inspired by fluid dynamics principles, not an actual fluid dynamics simulation. It serves as one weighted component among multiple priority calculation algorithms.

### Extensibility

The priority system is designed to support additional algorithms and signals as requirements evolve. New priority factors can be added to the weighted calculation system without disrupting existing functionality.

1. Transportation: Transport between nodes, if available
2. Production: Manufacturing or making of items
3. Resource: Scrooping to fuel the entire thing is counted differently than production.
4. Facility: Tasks built around facilities
5. Maintenance: These are time based tasks, refresh reservations, do maintenance supplies, etc.
6. User: Things that end users want us to do out side of the production system. 
7. Event: These may be triggered based on something happening in the game (like border bases, or death rate spike, invasion, or partisans)


---
This specification provides a foundation for implementing the task layer, ensuring user interactions are clear, 
actionable, and manageable while maintaining flexibility for future enhancements.

